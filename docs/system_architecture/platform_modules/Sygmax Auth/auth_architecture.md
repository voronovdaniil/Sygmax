# Архитектура Sygmax Auth-сервиса -- авторизация и аутентификация пользователей


## Хранение и разделение пользовательских данных между Auth Service и другими микросервисами системы

### Кейс
Так как внутри платформы Sygmax данные о пользователе хранятся в виде сложной топологии настроек, 
представляющих собой
- учетные данные пользователя,
- настройки уведомлений,
- доступ к командам и воркспейсам
и прочие параметры

то целесообразнее разделить логику управления пользовательскими настройками на два микросервисами:
- микросервис аутентификации пользователя
- микросервис управления пользовательским профилем

Это обусловлено рядом факторов:
- дианмичность настроек пользователя: настройки в рамказ разных воркспейсов могут отличаться
- логика хранения пользовательских данных в таком случае является гибридной и состоит из 
    - глоабльных настроек (ФИО, email) 
    - и локальных (настройки на уровне воркспейсов)

При смене воркспейса аккаунт пользователя остается неизменным, а настройки 
воркспейсов обновляются на соответствующие

Поэтому вместо одного микросервиса с усложненной бизнес-логикой у нас появляются три микросервиса
- Auth Service отвечает только за учетные данные пользователя (email, пароль, роли).
- Profile Service управляет глобальными данными профиля (ФИО, аватар, email, язык) и локальными настройками воркспейса.
- Workspace Service – управление воркспейсами (список, права доступа).

#### Хранение данных

- Таблица users (Auth Service) – ID, email, пароль.
- Таблица profiles (Profile Service) – ID пользователя, ФИО, аватар.
- Таблица workspace_settings (Profile Service) – ID пользователя, ID воркспейса, настройки.

#### Как работает система входа в систему и получение данных о пользователе

- Клиент отправляет учетные данные (email + пароль) → Auth Service.

- Auth Service проверяет пользователя, создает JWT.

- Auth Service сразу же запрашивает из Profile Service данные профиля.

- Auth Service запрашивает из Workspace Service список воркспейсов пользователя.

- Auth Service возвращает клиенту:
    - JWT
    - Данные профиля (ФИО, email, аватар)
    - Список воркспейсов (ID, названия, роли в каждом из них)
- Клиент автоматически отображает воркспейсы в боковом меню и использует данные профиля.


#### Как работает удаление пользовательского аккаунта

- Запрос на удаление (DELETE /auth/delete-account).
- Проверка пользователя (Auth Service запрашивает пароль/2FA для подтверждения).
- Удаление данных:
    - Workspace Service:
        - Удаляет все воркспейсы, где пользователь создатель.
        - Исключает пользователя из воркспейсов, где он просто член.
P   - Profile Service:
        - Удаляет все персональные настройки.
    - Auth Service:
        - Удаляет учетные данные пользователя.
        - Возвращается подтверждение удаления.


#### Базовые паттерны авторизации в API

| **Эндпоинт**      | **Метод** | **Описание** |
|------------------|----------|-------------|
| `/auth/login`    | `POST`   | Логин: возвращает `JWT`, данные профиля и воркспейсы |
| `/auth/me`       | `GET`    | Получить текущие данные профиля |
| `/workspaces`    | `GET`    | Получить список воркспейсов пользователя |
| `/auth/delete-account` | `DELETE` | Полное удаление аккаунта, выход из воркспейсов, удаление созданных воркспейсов |


## Методы аутентификации и авторизации пользователей на платформе Sygmax

**Варианты аутентификации**
- JWT (JSON Web Token)
✅ Подходит для микросервисной архитектуры.
✅ Не требует хранения сессий на сервере.
✅ Удобно масштабировать.
❌ Требует работы с refresh-токенами для продления сессии.

- OAuth2.0 (Google, GitHub, Facebook)
✅ Позволяет пользователям входить через сторонние сервисы.
✅ Упрощает регистрацию, нет паролей.
❌ Требует интеграции с провайдерами.
❌ Не подходит как основной метод (скорее дополнительный).

- SSO (Single Sign-On, корпоративная авторизация)
✅ Удобно для корпоративных клиентов.
✅ Позволяет единый вход в разные системы.
❌ Избыточно для начального этапа.

### 1: Аутентификация через JWT (JSON Web Token)

**Как работает вход пользователя в систему через JWT?**

- Пользователь вводит email + пароль и отправляет запрос на сервер (POST /auth/login).
- Sygmax Auth проверяет учетные данные (ищет пользователя в базе, сверяет пароль).
- Если все ок – сервер выдает два токена:

    - Access Token (короткоживущий, например, 1 час)
    - Refresh Token (долго живущий, например, 7 дней)

- Клиент (браузер, мобильное приложение) использует Access Token для всех запросов.
- Когда Access Token истекает, клиент отправляет Refresh Token на сервер (POST /auth/refresh).
- Сервер проверяет Refresh Token, выдает новый Access Token.
- Если Refresh Token тоже истек, пользователю нужно снова войти в систему.


**Как сервер проверяет пользователя в каждом запросе?**

Клиент передает Access Token в заголовке:
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

API Gateway (FastAPI) перехватывает запрос и проверяет валидность токена.

Если токен валиден, запрос передается в нужный сервис (Core, Chats и т. д.).

Если токен невалиден или истек – клиенту нужно получить новый.

**Как пользователь будет входить в систему в первый раз?**

- Регистрируется через POST /auth/register (email + пароль).
- Получает на почту письмо для подтверждения аккаунта (если нужно).
- Заходит через POST /auth/login (отправляет email + пароль).
- Получает Access Token + Refresh Token.
- Использует Access Token для запросов в систему.

### 2. Аутентификация через OAuth 2.0 (Google, GitHub, Facebook)

**Как работает вход пользователя в систему через OAuth 2.0**
1. Пользователь нажимает "Войти через Google/GitHub".
2. Браузер перенаправляется на страницу авторизации провайдера (Google, GitHub).
3. Пользователь вводит свои учетные данные и дает разрешение на доступ к email, имени и другим данным.
4. Провайдер (Google/GitHub) отправляет Auth Code обратно в Sygmax Auth.
5. Sygmax Auth отправляет Auth Code в Google/GitHub, чтобы обменять его на Access Token.
6. С Access Token сервер запрашивает у Google/GitHub данные пользователя (email, имя, аватар и т. д.).
7. Если email уже зарегистрирован в системе, сервер выдает пользователю JWT, и он входит в систему.
8. Если email новый, сервер создает нового пользователя, записывает его в базу и затем выдает JWT.
9. Клиент использует JWT для работы с системой, как и в варианте с обычной авторизацией.

**Какие API-эндпоинты нужны?**

| **Эндпоинт**          | **Метод** | **Описание** |
|-----------------------|----------|-------------|
| `/auth/google-login`  | `GET`    | Перенаправляет пользователя на страницу авторизации Google |
| `/auth/github-login`  | `GET`    | Перенаправляет пользователя на страницу авторизации GitHub |
| `/auth/oauth-callback` | `POST`   | Получает `Auth Code`, запрашивает `Access Token`, возвращает `JWT` |

**Как пользователь будет входить в систему?**

- Нажимает "Войти через Google/GitHub".
- Перенаправляется на страницу Google/GitHub.
- Авторизуется и дает разрешение на передачу данных.
- Sygmax Auth получает данные пользователя.
- Если пользователь уже есть в системе – выдается JWT.
- Если пользователь новый – создается запись в базе и затем выдается JWT.
- Пользователь работает в системе с JWT.





