# Архитектура Sygmax Auth-сервиса -- авторизация и аутентификация пользователей

## Методы аутентификации и авторизации пользователей на платформе Sygmax

**Варианты аутентификации**
- JWT (JSON Web Token)
✅ Подходит для микросервисной архитектуры.
✅ Не требует хранения сессий на сервере.
✅ Удобно масштабировать.
❌ Требует работы с refresh-токенами для продления сессии.

- OAuth2.0 (Google, GitHub, Facebook)
✅ Позволяет пользователям входить через сторонние сервисы.
✅ Упрощает регистрацию, нет паролей.
❌ Требует интеграции с провайдерами.
❌ Не подходит как основной метод (скорее дополнительный).

- SSO (Single Sign-On, корпоративная авторизация)
✅ Удобно для корпоративных клиентов.
✅ Позволяет единый вход в разные системы.
❌ Избыточно для начального этапа.

## 1: Аутентификация через JWT (JSON Web Token)

**Как работает вход пользователя в систему через JWT?**

- Пользователь вводит email + пароль и отправляет запрос на сервер (POST /auth/login).
- Sygmax Auth проверяет учетные данные (ищет пользователя в базе, сверяет пароль).
- Если все ок – сервер выдает два токена:

    - Access Token (короткоживущий, например, 1 час)
    - Refresh Token (долго живущий, например, 7 дней)

- Клиент (браузер, мобильное приложение) использует Access Token для всех запросов.
- Когда Access Token истекает, клиент отправляет Refresh Token на сервер (POST /auth/refresh).
- Сервер проверяет Refresh Token, выдает новый Access Token.
- Если Refresh Token тоже истек, пользователю нужно снова войти в систему.


**Как сервер проверяет пользователя в каждом запросе?**

Клиент передает Access Token в заголовке:
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

API Gateway (FastAPI) перехватывает запрос и проверяет валидность токена.

Если токен валиден, запрос передается в нужный сервис (Core, Chats и т. д.).

Если токен невалиден или истек – клиенту нужно получить новый.

**Как пользователь будет входить в систему в первый раз?**

- Регистрируется через POST /auth/register (email + пароль).
- Получает на почту письмо для подтверждения аккаунта (если нужно).
- Заходит через POST /auth/login (отправляет email + пароль).
- Получает Access Token + Refresh Token.
- Использует Access Token для запросов в систему.

## Аутентификация через OAuth 2.0 (Google, GitHub, Facebook)

**Как работает вход пользователя в систему через OAuth 2.0**
1. Пользователь нажимает "Войти через Google/GitHub".
2. Браузер перенаправляется на страницу авторизации провайдера (Google, GitHub).
3. Пользователь вводит свои учетные данные и дает разрешение на доступ к email, имени и другим данным.
4. Провайдер (Google/GitHub) отправляет Auth Code обратно в Sygmax Auth.
5. Sygmax Auth отправляет Auth Code в Google/GitHub, чтобы обменять его на Access Token.
6. С Access Token сервер запрашивает у Google/GitHub данные пользователя (email, имя, аватар и т. д.).
7. Если email уже зарегистрирован в системе, сервер выдает пользователю JWT, и он входит в систему.
8. Если email новый, сервер создает нового пользователя, записывает его в базу и затем выдает JWT.
9. Клиент использует JWT для работы с системой, как и в варианте с обычной авторизацией.

**Какие API-эндпоинты нужны?**

| **Эндпоинт**          | **Метод** | **Описание** |
|-----------------------|----------|-------------|
| `/auth/google-login`  | `GET`    | Перенаправляет пользователя на страницу авторизации Google |
| `/auth/github-login`  | `GET`    | Перенаправляет пользователя на страницу авторизации GitHub |
| `/auth/oauth-callback` | `POST`   | Получает `Auth Code`, запрашивает `Access Token`, возвращает `JWT` |

**Как пользователь будет входить в систему?**

- Нажимает "Войти через Google/GitHub".
- Перенаправляется на страницу Google/GitHub.
- Авторизуется и дает разрешение на передачу данных.
- Sygmax Auth получает данные пользователя.
- Если пользователь уже есть в системе – выдается JWT.
- Если пользователь новый – создается запись в базе и затем выдается JWT.
- Пользователь работает в системе с JWT.

## Аутентификация через SSO (Single Sign-On, корпоративная авторизация)

**Как работает вход пользователя в систему через SSO?**

- Пользователь нажимает "Войти через корпоративный аккаунт".
- Браузер перенаправляется на страницу авторизации корпоративного провайдера (например, Microsoft Azure AD, Okta, Keycloak, SAML-провайдер).
- Пользователь вводит свои корпоративные учетные данные (логин/пароль или одноразовый токен).
- Провайдер SSO проверяет учетные данные и отправляет токен (SAML Assertion или OAuth Access Token) обратно в Sygmax Auth.
- Sygmax Auth проверяет токен у корпоративного провайдера, запрашивает данные пользователя (email, имя, роли).
- Если email уже зарегистрирован в системе, сервер выдает JWT, и пользователь входит в систему.
- Если email новый, система проверяет, есть ли политика автоматической регистрации, и либо создает нового пользователя, либо отклоняет запрос.
- Клиент использует JWT, чтобы работать в системе.

**Преимущества SSO**

- Пользователь использует одну учетную запись для всех корпоративных систем.
- Безопасность на стороне компании (например, можно настроить 2FA, ограничение доступа по IP).
- Можно интегрироваться с LDAP, Active Directory, SAML, OAuth2.
- Позволяет компаниям централизованно управлять пользователями и их доступами.

**Недостатки SSO**

- Требует интеграции с корпоративным Identity-провайдером.
- Усложняет архитектуру аутентификации, требует настройки безопасности.
- Если корпоративный провайдер недоступен, пользователи не смогут войти.
- Может быть избыточным для небольших команд и публичных пользователей.

**Какие API-эндпоинты нужны?**

| **Эндпоинт**          | **Метод** | **Описание** |
|-----------------------|----------|-------------|
| `/auth/sso-login`     | `GET`    | Перенаправляет пользователя на корпоративный SSO |
| `/auth/sso-callback`  | `POST`   | Получает токен (`SAML`/`OAuth`), запрашивает данные пользователя, выдает `JWT` |

**Как пользователь будет входить в систему?**
- Нажимает "Войти через корпоративный аккаунт".
- Перенаправляется на страницу корпоративного провайдера.
- Авторизуется с учетными данными компании.
- Sygmax Auth получает подтверждение и токен (SAML Assertion или OAuth Token).
- Если пользователь уже зарегистрирован – получает JWT и входит.
- Если пользователь новый – система либо создает его автоматически, либо отклоняет вход (в зависимости от настроек).
- Пользователь работает в системе с JWT.


